generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Survey settings for response collection
enum SurveyAccessType {
  UNLISTED     // Anyone with the link can respond
  INVITE_ONLY  // Only invited email addresses can respond
}

// Collaborator roles for team collaboration
enum CollaboratorRole {
  OWNER   // Full access, can delete survey and manage team
  EDITOR  // Can edit survey and view responses
  VIEWER  // Can only view survey and responses
}

// Survey - the main survey entity
model Survey {
  id                   String           @id @default(cuid())
  title                String
  description          String?
  published            Boolean          @default(false)
  userId               String           // Clerk user ID - survey owner
  accessType           SurveyAccessType @default(UNLISTED)
  isAnonymous          Boolean          @default(true) // If true, don't track respondent identity
  closesAt             DateTime?        // Optional deadline
  // Reminder settings
  reminderEnabled      Boolean          @default(false)
  reminderIntervalDays Int              @default(3) // Days between reminders
  reminderMaxCount     Int              @default(2) // Max reminders per invitation
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  questions            Question[]
  responses            Response[]
  invitations          Invitation[]
  collaborators        SurveyCollaborator[]
  collaboratorInvites  CollaboratorInvitation[]
  webhooks             Webhook[]
  alerts               Alert[]

  @@index([published])
  @@index([userId])
  @@index([closesAt]) // For filtering expired surveys
}

// Invitation - tracks who has been invited to a survey
model Invitation {
  id               String    @id @default(cuid())
  surveyId         String
  survey           Survey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  email            String
  token            String    @unique @default(cuid()) // Magic link token
  sentAt           DateTime  @default(now())
  openedAt         DateTime? // When they clicked the link
  completedAt      DateTime? // When they submitted a response
  responseId       String?   // Link to their response (if not anonymous)
  // Reminder tracking
  reminderCount    Int       @default(0) // How many reminders have been sent
  lastReminderAt   DateTime? // When the last reminder was sent
  createdAt        DateTime  @default(now())

  @@unique([surveyId, email])
  @@index([surveyId])
  @@index([token])
  @@index([email]) // For lookup by email
}

// Question types enum
enum QuestionType {
  // Text inputs
  SHORT_TEXT
  LONG_TEXT
  EMAIL
  PHONE
  NUMBER
  URL             // Website/URL input with validation
  // Date/Time
  DATE
  TIME
  // Choice questions
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  DROPDOWN        // Single select dropdown (compact for many options)
  YES_NO          // Simple yes/no toggle
  IMAGE_CHOICE    // Select from image options
  // Rating/Scale questions
  RATING          // Star rating (1-5)
  SCALE           // Linear scale
  NPS             // Net Promoter Score (0-10)
  LIKERT          // Opinion scale (Strongly Disagree to Strongly Agree)
  SLIDER          // Visual slider on a range
  // Advanced questions
  MATRIX          // Grid rating - rate multiple items on same scale
  RANKING         // Drag to order items by preference
  CONSTANT_SUM    // Distribute points across options (must sum to total)
  // File & Media
  FILE_UPLOAD     // Upload files (documents, images, etc.)
  SIGNATURE       // Digital signature capture
  // Location
  ADDRESS         // Address/location input
  // Special
  HIDDEN          // Hidden field for tracking (not shown to respondent)
  // Display elements
  SECTION_HEADER  // Display-only section break (no input)
  WELCOME_SCREEN  // Introduction screen with start button
  END_SCREEN      // Thank you / completion screen
  STATEMENT       // Display-only text/info (no input required)
  LEGAL           // Consent/terms acceptance checkbox
}

// Question - individual questions in a survey
model Question {
  id          String       @id @default(cuid())
  surveyId    String
  survey      Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  type        QuestionType
  title       String
  description String?
  required    Boolean      @default(false)
  order       Int
  options     Json?        // For choice questions: ["Option 1", "Option 2", ...]
  settings    Json?        // Type-specific settings (min/max for scale, etc.)
  answers     Answer[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([surveyId])
  @@index([order])
}

// Response - a single survey submission
model Response {
  id              String   @id @default(cuid())
  surveyId        String
  survey          Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  answers         Answer[]
  respondentEmail String?  // Only stored if survey is not anonymous
  respondentName  String?  // Only stored if survey is not anonymous
  invitationToken String?  // If came from invitation
  completedAt     DateTime @default(now())
  metadata        Json?    // Optional: user agent, referrer, etc.

  @@index([surveyId])
  @@index([completedAt])
  @@index([invitationToken])
  @@index([surveyId, completedAt]) // Compound index for efficient filtering
}

// Answer - individual answer to a question
model Answer {
  id         String   @id @default(cuid())
  responseId String
  response   Response @relation(fields: [responseId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  value      Json     // Flexible: string, number, array of selected options, etc.
  createdAt  DateTime @default(now())

  @@index([responseId])
  @@index([questionId])
}

// Email Group - reusable lists of email recipients
model EmailGroup {
  id        String             @id @default(cuid())
  name      String             // e.g., "C-Suite", "Guild", "Contractors"
  userId    String             // Clerk user ID - group owner
  color     String?            // Optional color for UI display
  members   EmailGroupMember[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

// Email Group Member - individual email in a group
model EmailGroupMember {
  id        String     @id @default(cuid())
  groupId   String
  group     EmailGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  email     String
  name      String?    // Optional display name
  createdAt DateTime   @default(now())

  @@unique([groupId, email])
  @@index([groupId])
}

// Survey Collaborator - users with access to a survey
model SurveyCollaborator {
  id         String           @id @default(cuid())
  surveyId   String
  survey     Survey           @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  userId     String           // Clerk user ID of the collaborator
  email      String           // Email for display purposes
  role       CollaboratorRole
  invitedBy  String?          // Clerk user ID of who invited them
  invitedAt  DateTime         @default(now())
  acceptedAt DateTime?        // When they accepted the invite
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@unique([surveyId, userId])
  @@unique([surveyId, email])
  @@index([surveyId])
  @@index([userId])
}

// Collaborator Invitation - pending invites to collaborate on a survey
model CollaboratorInvitation {
  id        String           @id @default(cuid())
  surveyId  String
  survey    Survey           @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  email     String           // Email to invite
  role      CollaboratorRole
  token     String           @unique @default(cuid()) // Invite token
  invitedBy String           // Clerk user ID of who invited them
  expiresAt DateTime         // When the invite expires
  createdAt DateTime         @default(now())

  @@unique([surveyId, email])
  @@index([token])
  @@index([surveyId])
}

// ============================================
// AUTOMATED ALERTS & WEBHOOKS
// ============================================

// Event types that can trigger notifications
enum EventType {
  RESPONSE_SUBMITTED  // When any response is submitted
  SURVEY_COMPLETED    // When survey reaches response goal
  TRIGGER_MATCHED     // When a specific trigger condition is met
}

// Notification channels
enum NotificationChannel {
  EMAIL
  SLACK
  WEBHOOK
}

// Comparison operators for trigger conditions
enum TriggerOperator {
  EQUALS
  NOT_EQUALS
  GREATER_THAN
  LESS_THAN
  CONTAINS
  IS_EMPTY
}

// Webhook - HTTP endpoint to receive survey events
model Webhook {
  id         String            @id @default(cuid())
  surveyId   String
  survey     Survey            @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  name       String            // Display name
  url        String            // Webhook URL
  secret     String?           // Optional secret for signature verification
  enabled    Boolean           @default(true)
  events     EventType[]       // Which events to send
  headers    Json?             // Custom headers to include
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  deliveries WebhookDelivery[]

  @@index([surveyId])
}

// Webhook Delivery - tracks each webhook call attempt
model WebhookDelivery {
  id           String    @id @default(cuid())
  webhookId    String
  webhook      Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  eventType    EventType
  payload      Json      // What was sent
  responseCode Int?      // HTTP response status
  responseBody String?   // Response body (truncated)
  error        String?   // Error message if failed
  duration     Int?      // Request duration in ms
  deliveredAt  DateTime  @default(now())

  @@index([webhookId])
  @@index([deliveredAt])
}

// Alert - notification rule for survey events
model Alert {
  id        String              @id @default(cuid())
  surveyId  String
  survey    Survey              @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  name      String              // Display name
  channel   NotificationChannel // How to notify
  enabled   Boolean             @default(true)
  config    Json                // Channel-specific config (email addresses, slack webhook URL, etc.)
  triggers  AlertTrigger[]      // Conditions that must be met
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@index([surveyId])
}

// Alert Trigger - condition that triggers an alert
model AlertTrigger {
  id         String          @id @default(cuid())
  alertId    String
  alert      Alert           @relation(fields: [alertId], references: [id], onDelete: Cascade)
  questionId String          // Which question to check
  operator   TriggerOperator // Comparison operator
  value      Json            // Value to compare against

  @@index([alertId])
}
